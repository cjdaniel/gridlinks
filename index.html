<!DOCTYPE html>
<html lang="en">

<head>
 <title>Grid Links</title>
 <meta charset="utf-8">
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin="">
 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

 <style>
    body {
       margin: 0;
       padding: 0;

       background: #eeeeee;
       color: #111111;
       font-family: Helvetica, sans-serif;
    }
    html, body {
       width: 100%;
       height: 100%;
    }
    h1 {
        margin: 1em auto 0.5em auto;
        font-size: 40px;
        text-align: center;
        color: black;
        text-shadow: 1px 1px 2px #666;
    }
    p {
        text-align: center;
    }
    p.sub {
        color: #666;
    }
    .critical {
        color: #cc1111;
    }
    a {
        color: #6495ed;
    }
    a:hover {
        text-decoration: none;
    }
    table#legend {
        margin: auto;
        font-size: 2em;
    }
    table#legend td {
        padding-left: 0.3em;
    }
    div#map {
        width: 75%;
        height: 75%;
        margin: auto;
        border: 3px solid #6495ed;
    }

    #footer p {
        color: #eeeeee;
    }

    .openmarker, .closedmarker, .defaultmarker {
        font-size: 30px; /* needs to correspond to size below */
    }

    #dark-toggle {
        position: fixed;
        top: 1em;
        right: 1em;
        background: none;
        border: none;
        padding: 0.4em 0.7em;
        cursor: pointer;
        font-size: 18px;
        z-index: 1000;
        line-height: 1;
    }

    body.dark {
        background: #1a1a1a;
        color: #e0e0e0;
    }
    body.dark h1 {
        color: white;
        text-shadow: 1px 1px 2px #000;
    }
    body.dark p.sub {
        color: #999;
    }
    body.dark .critical {
        color: #ff4444;
    }
    body.dark #footer p {
        color: #1a1a1a;
    }
    body.dark .leaflet-tile-pane {
        filter: brightness(0.5);
    }
    body.dark .leaflet-bar a {
        background-color: #333;
        color: #e0e0e0;
        border-bottom-color: #555;
    }
    body.dark .leaflet-bar a:hover {
        background-color: #444;
    }
    body.dark .leaflet-control-attribution {
        background-color: rgba(30, 30, 30, 0.8) !important;
        color: #999;
    }
    body.dark .leaflet-control-attribution a {
        color: #6495ed;
    }
 </style>

 <script>
    // Apply dark mode before page renders to avoid flash
    (function() {
        var pref = localStorage.getItem('darkMode');
        var isDark = pref === 'true' || (pref === null && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (isDark) document.documentElement.style.background = '#1a1a1a';
    })();
 </script>

</head>

<body>
 <button id="dark-toggle" aria-label="Toggle dark/light style" title="Toggle dark/light style"></button>
 <h1>GRID LINKS</h1>
 <p>The map below shows the open or closed status of <span class="critical">critical bicycle and pedestrian links</span> across urban barriers like highways.</p>
 <table id="legend">
  <tr>
   <td>&#x1f499;</td><td>Open!</td>
  </tr>
  <tr>
   <td>&#x1f494;</td><td>CLOSED :(</td>
  </tr>
 </table>
 <p><strong id="last-updated"></strong></p>
 <p>Click on a map marker below for more information about a crossing.</p>
 <p class="sub">Contributions welcome: <a href="mailto:gridlinks@chrisdaniel.net">E-mail</a> | <a href="https://bsky.app/profile/chrisdaniel.net">Bluesky</a> | <a href="https://mstdn.social/@cjdaniel">Mastodon</a> | <a href="https://github.com/cjdaniel/gridlinks/">Source code</a></p>

 <div id="map"></div>
 <p class="sub">Contributions welcome: <a href="mailto:gridlinks@chrisdaniel.net">E-mail</a> | <a href="https://bsky.app/profile/chrisdaniel.net">Bluesky</a> | <a href="https://mstdn.social/@cjdaniel">Mastodon</a> | <a href="https://github.com/cjdaniel/gridlinks/">Source code</a></p>

 <script>
 var map = L.map('map').setView([44.964085426290396, -93.2629625179114], 13);

 L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Base map &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

 const size = 30; // needs to correspond to font-size above
 const openIconOptions = {
   iconSize  : [size, size],
   iconAnchor: [size/2, size + 9], 
   className : 'openmarker',
   html: '&#x1f499'
 }
 const closedIconOptions = {
   iconSize  : [size, size],
   iconAnchor: [size/2, size + 9], 
   className : 'closedmarker',
   html: '&#x1f494'
 }
 const defaultIconOptions = {
   iconSize  : [size, size],
   iconAnchor: [size/2, size + 9], 
   className : 'defaultmarker',
   html: '&#x2754'
 }
 const openMarkerOptions = {
   icon: L.divIcon(openIconOptions)
 }
 const closedMarkerOptions = {
   icon: L.divIcon(closedIconOptions)
 }
 const defaultMarkerOptions = {
   icon: L.divIcon(defaultIconOptions)
 }

 let xhr = new XMLHttpRequest();
 xhr.open('GET', 'gridlinks.geojson');
 xhr.setRequestHeader('Content-Type', 'application/json');
 xhr.responseType = 'json';
 xhr.onload = function() {
     if (xhr.status !== 200) return
     let latestDate = '';
     xhr.response.features.forEach(function(f) {
         if (f.properties.last_updated && f.properties.last_updated > latestDate) {
             latestDate = f.properties.last_updated;
         }
     });
     if (latestDate) {
         const [y, m, d] = latestDate.split('-').map(Number);
         const dateObj = new Date(y, m - 1, d);
         const formatted = dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
         document.getElementById('last-updated').textContent = 'Last updated ' + formatted;
     }

     L.geoJSON(xhr.response, {
        pointToLayer: function(feature, latlng) {
            marker = L.marker();

            if(feature.properties && feature.properties.status) {
                switch(feature.properties.status) {
                    case 'open':
                        marker=L.marker(latlng, openMarkerOptions);
                        break;
                    case 'closed':
                        marker=L.marker(latlng, closedMarkerOptions);
                        break;
                    default:
                        marker=L.marker(latlng, defaultMarkerOptions);
                }
            }
            return marker;
        },
        onEachFeature: function(feature, layer) {
            details = '';
            if(feature.properties && feature.properties.status) {
                switch(feature.properties.status) {
                    case 'closed':
                        details += 'Reason: '+feature.properties.reason+'<br/>'
                            +'Agency: '+feature.properties.agency+'<br/>'
                        break;
                }
                details += 'Source: '+feature.properties.source+'<br/>'
                    +'Last updated: '+feature.properties.last_updated+'<br/>'
            }
            layer.bindPopup(
                '<strong>'+feature.properties.name+'</strong><br/>'
                +'Status: '+feature.properties.status+'<br/>'
                +details
            );
        }
     }).addTo(map);
 };
 xhr.send();

 // Dark mode toggle
 (function() {
     var pref = localStorage.getItem('darkMode');
     var isDark = pref === 'true' || (pref === null && window.matchMedia('(prefers-color-scheme: dark)').matches);
     var toggle = document.getElementById('dark-toggle');

     function applyDark(dark) {
         document.body.classList.toggle('dark', dark);
         document.documentElement.style.background = dark ? '#1a1a1a' : '';
         toggle.textContent = dark ? '\u2600\uFE0F' : '\uD83C\uDF19';
     }

     applyDark(isDark);

     toggle.addEventListener('click', function() {
         isDark = !isDark;
         applyDark(isDark);
         localStorage.setItem('darkMode', isDark);
     });

     // Follow OS changes if user hasn't manually chosen
     window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
         if (localStorage.getItem('darkMode') === null) {
             isDark = e.matches;
             applyDark(isDark);
         }
     });
 })();

 </script>

 <div id="footer">
  <p>This page was made by a human, for humans.</p>
 </div>

</body>

</html>
